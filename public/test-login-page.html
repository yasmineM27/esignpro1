<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Page de Connexion</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            cursor: pointer; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            background: #007bff;
            color: white;
        }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .test-result.success { border-left-color: #28a745; background: #f8fff9; }
        .test-result.error { border-left-color: #dc3545; background: #fff8f8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .account-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de la Page de Connexion Corrig√©e</h1>
        
        <div class="section info">
            <h2>üìã Comptes de Test Disponibles</h2>
            <div class="grid">
                <div class="account-card">
                    <h3>üëë Administrateur</h3>
                    <p><strong>Email:</strong> waelha@gmail.com</p>
                    <p><strong>MDP:</strong> temp466265</p>
                    <p><strong>Redirection:</strong> /admin</p>
                </div>
                <div class="account-card">
                    <h3>üîß Agent</h3>
                    <p><strong>Email:</strong> agent.test@esignpro.ch</p>
                    <p><strong>MDP:</strong> test123</p>
                    <p><strong>Redirection:</strong> /agent-dashboard</p>
                </div>
                <div class="account-card">
                    <h3>üë§ Client</h3>
                    <p><strong>Email:</strong> client.test@esignpro.ch</p>
                    <p><strong>MDP:</strong> client123</p>
                    <p><strong>Redirection:</strong> /client-dashboard</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üöÄ Test Automatique de Toutes les Connexions</h2>
            <button class="btn-success" onclick="testAllLogins()">üß™ TESTER TOUTES LES CONNEXIONS</button>
            <div id="test-results"></div>
        </div>

        <div class="section">
            <h2>üåê Test Manuel</h2>
            <p>Cliquez sur les liens ci-dessous pour tester manuellement :</p>
            <div style="margin: 20px 0;">
                <a href="/login" target="_blank" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px;">
                    üö™ Page de Connexion Principale
                </a>
                <a href="/agent-login" target="_blank" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; margin: 5px;">
                    üîß Connexion Agent Sp√©cialis√©e
                </a>
            </div>
        </div>

        <div class="section">
            <h2>üìä R√©sultats des Tests</h2>
            <div id="summary">
                <p>Cliquez sur "TESTER TOUTES LES CONNEXIONS" pour voir les r√©sultats.</p>
            </div>
        </div>
    </div>

    <script>
        const testAccounts = [
            {
                name: 'Administrateur',
                email: 'waelha@gmail.com',
                password: 'temp466265',
                expectedRole: 'admin',
                expectedRedirect: '/admin'
            },
            {
                name: 'Agent',
                email: 'agent.test@esignpro.ch',
                password: 'test123',
                expectedRole: 'agent',
                expectedRedirect: '/agent-dashboard'
            },
            {
                name: 'Client',
                email: 'client.test@esignpro.ch',
                password: 'client123',
                expectedRole: 'client',
                expectedRedirect: '/client-dashboard'
            }
        ];

        async function testLogin(account) {
            try {
                // Essayer d'abord avec user-login
                let response = await fetch('/api/auth/user-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: account.email,
                        password: account.password
                    })
                });

                let data = await response.json();

                // Si √©chec avec user-login, essayer avec agent-login pour les agents
                if (!data.success && account.email.includes('@esignpro.ch')) {
                    response = await fetch('/api/auth/agent-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: account.email,
                            password: account.password
                        })
                    });
                    data = await response.json();
                }

                return {
                    success: data.success,
                    user: data.user,
                    error: data.error,
                    account: account
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message,
                    account: account
                };
            }
        }

        async function testAllLogins() {
            const resultsDiv = document.getElementById('test-results');
            const summaryDiv = document.getElementById('summary');
            
            resultsDiv.innerHTML = '<p>‚è≥ Test en cours...</p>';
            
            let results = [];
            let successCount = 0;
            let errorCount = 0;

            for (const account of testAccounts) {
                const result = await testLogin(account);
                results.push(result);
                
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                }
            }

            // Afficher les r√©sultats
            let html = '<h3>üìã R√©sultats D√©taill√©s :</h3>';
            
            results.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                
                html += `
                    <div class="test-result ${statusClass}">
                        <h4>${statusIcon} ${result.account.name}</h4>
                        <p><strong>Email:</strong> ${result.account.email}</p>
                `;
                
                if (result.success) {
                    html += `
                        <p><strong>‚úÖ Connexion:</strong> R√©ussie</p>
                        <p><strong>üë§ Utilisateur:</strong> ${result.user.first_name} ${result.user.last_name}</p>
                        <p><strong>üé≠ R√¥le:</strong> ${result.user.role}</p>
                        <p><strong>üìß Email:</strong> ${result.user.email}</p>
                    `;
                    
                    // V√©rifier le r√¥le
                    if (result.user.role === result.account.expectedRole) {
                        html += `<p><strong>‚úÖ R√¥le:</strong> Correct (${result.user.role})</p>`;
                    } else {
                        html += `<p><strong>‚ö†Ô∏è R√¥le:</strong> Attendu ${result.account.expectedRole}, re√ßu ${result.user.role}</p>`;
                    }
                } else {
                    html += `
                        <p><strong>‚ùå Erreur:</strong> ${result.error}</p>
                    `;
                }
                
                html += '</div>';
            });

            resultsDiv.innerHTML = html;

            // R√©sum√©
            const totalTests = testAccounts.length;
            const successRate = Math.round((successCount / totalTests) * 100);
            
            let summaryClass = 'info';
            if (successRate === 100) summaryClass = 'success';
            else if (successRate < 50) summaryClass = 'error';
            else if (successRate < 100) summaryClass = 'warning';

            summaryDiv.innerHTML = `
                <div class="${summaryClass}">
                    <h3>üìä R√©sum√© des Tests</h3>
                    <p><strong>Total:</strong> ${totalTests} comptes test√©s</p>
                    <p><strong>‚úÖ R√©ussis:</strong> ${successCount}</p>
                    <p><strong>‚ùå √âchou√©s:</strong> ${errorCount}</p>
                    <p><strong>üìà Taux de r√©ussite:</strong> ${successRate}%</p>
                    ${successRate === 100 ? 
                        '<p><strong>üéâ Tous les tests sont pass√©s ! La page de connexion fonctionne parfaitement.</strong></p>' :
                        '<p><strong>‚ö†Ô∏è Certains tests ont √©chou√©. V√©rifiez les d√©tails ci-dessus.</strong></p>'
                    }
                </div>
            `;
        }

        // Auto-test apr√®s 3 secondes
        window.onload = function() {
            console.log('üß™ Page de test de connexion charg√©e');
            
            setTimeout(() => {
                if (confirm('Lancer automatiquement les tests de connexion ?')) {
                    testAllLogins();
                }
            }, 3000);
        };
    </script>
</body>
</html>
