<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Syst√®me de Mots de Passe</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            cursor: pointer; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .user-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test du Syst√®me de Mots de Passe</h1>
        
        <div class="test-section">
            <h2>1. R√©cup√©rer la Liste des Utilisateurs</h2>
            <button class="btn-primary" onclick="loadUsers()">Charger les Utilisateurs</button>
            <div id="users-result"></div>
        </div>

        <div class="test-section">
            <h2>2. Changer le Mot de Passe d'un Utilisateur</h2>
            <div class="form-group">
                <label>S√©lectionner un utilisateur :</label>
                <select id="userSelect">
                    <option value="">-- S√©lectionner un utilisateur --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nouveau mot de passe :</label>
                <input type="password" id="newPassword" placeholder="Entrez le nouveau mot de passe">
            </div>
            <button class="btn-warning" onclick="generatePassword()">üîÑ G√©n√©rer un Mot de Passe</button>
            <button class="btn-success" onclick="changePassword()">üîë Changer le Mot de Passe</button>
            <div id="password-result"></div>
        </div>

        <div class="test-section">
            <h2>3. Tester la Connexion avec le Nouveau Mot de Passe</h2>
            <div class="form-group">
                <label>Email de l'agent :</label>
                <input type="email" id="loginEmail" placeholder="email@esignpro.ch">
            </div>
            <div class="form-group">
                <label>Mot de passe :</label>
                <input type="password" id="loginPassword" placeholder="Mot de passe">
            </div>
            <button class="btn-primary" onclick="testLogin()">üö™ Tester la Connexion</button>
            <div id="login-result"></div>
        </div>

        <div class="test-section">
            <h2>4. G√©n√©rer un Mot de Passe Temporaire</h2>
            <div class="form-group">
                <label>Longueur du mot de passe :</label>
                <input type="number" id="passwordLength" value="10" min="6" max="20">
            </div>
            <button class="btn-warning" onclick="generateTempPassword()">üé≤ G√©n√©rer Mot de Passe</button>
            <div id="temp-password-result"></div>
        </div>
    </div>

    <script>
        let users = [];
        let selectedUser = null;

        async function loadUsers() {
            const resultDiv = document.getElementById('users-result');
            resultDiv.innerHTML = '<p>‚è≥ Chargement des utilisateurs...</p>';
            
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    users = data.users;
                    const userSelect = document.getElementById('userSelect');
                    userSelect.innerHTML = '<option value="">-- S√©lectionner un utilisateur --</option>';
                    
                    let usersHtml = '<div class="success"><h3>‚úÖ Utilisateurs charg√©s :</h3>';
                    
                    users.forEach(user => {
                        userSelect.innerHTML += `<option value="${user.id}">${user.first_name} ${user.last_name} (${user.email}) - ${user.role}</option>`;
                        usersHtml += `
                            <div class="user-card">
                                <strong>${user.first_name} ${user.last_name}</strong><br>
                                üìß ${user.email}<br>
                                üë§ ${user.role}<br>
                                üîÑ ${user.is_active ? 'Actif' : 'Inactif'}
                            </div>
                        `;
                    });
                    
                    usersHtml += '</div>';
                    resultDiv.innerHTML = usersHtml;
                } else {
                    resultDiv.innerHTML = `<div class="error"><h3>‚ùå Erreur:</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h3>‚ùå Erreur r√©seau:</h3><p>${error.message}</p></div>`;
            }
        }

        async function generatePassword() {
            try {
                const response = await fetch('/api/admin/change-password?length=12');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('newPassword').value = data.temporary_password;
                    document.getElementById('password-result').innerHTML = `
                        <div class="warning">
                            <h4>üîë Mot de passe g√©n√©r√© :</h4>
                            <p><strong>${data.temporary_password}</strong></p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('password-result').innerHTML = `
                    <div class="error">‚ùå Erreur g√©n√©ration : ${error.message}</div>
                `;
            }
        }

        async function changePassword() {
            const userId = document.getElementById('userSelect').value;
            const newPassword = document.getElementById('newPassword').value;
            const resultDiv = document.getElementById('password-result');
            
            if (!userId || !newPassword) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez s√©lectionner un utilisateur et entrer un mot de passe</div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>‚è≥ Changement du mot de passe...</p>';
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    selectedUser = users.find(u => u.id === userId);
                    document.getElementById('loginEmail').value = selectedUser.email;
                    document.getElementById('loginPassword').value = newPassword;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Mot de passe chang√© avec succ√®s!</h3>
                            <p><strong>Utilisateur:</strong> ${data.user.full_name}</p>
                            <p><strong>Email:</strong> ${data.user.email}</p>
                            <p><strong>Nouveau mot de passe:</strong> ${newPassword}</p>
                            <p>üí° Les champs de connexion ont √©t√© pr√©-remplis pour le test</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error"><h3>‚ùå Erreur:</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h3>‚ùå Erreur r√©seau:</h3><p>${error.message}</p></div>`;
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const resultDiv = document.getElementById('login-result');

            if (!email || !password) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez entrer email et mot de passe</div>';
                return;
            }

            resultDiv.innerHTML = '<p>‚è≥ Test de connexion...</p>';

            try {
                // Essayer d'abord avec l'API agent-login pour les agents
                let response = await fetch('/api/auth/agent-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                let data = await response.json();

                // Si √ßa √©choue avec agent-login, essayer avec user-login (plus flexible)
                if (!data.success) {
                    response = await fetch('/api/auth/user-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            password: password
                        })
                    });
                    data = await response.json();
                }

                if (data.success) {
                    let userInfo = `
                        <div class="success">
                            <h3>‚úÖ Connexion r√©ussie!</h3>
                            <p><strong>Utilisateur:</strong> ${data.user.first_name} ${data.user.last_name}</p>
                            <p><strong>Email:</strong> ${data.user.email}</p>
                            <p><strong>R√¥le:</strong> ${data.user.role}</p>
                    `;

                    // Ajouter les infos sp√©cifiques selon le r√¥le
                    if (data.user.role === 'agent' && data.user.agents && data.user.agents.length > 0) {
                        const agent = data.user.agents[0];
                        userInfo += `
                            <p><strong>Code Agent:</strong> ${agent.agent_code}</p>
                            <p><strong>D√©partement:</strong> ${agent.department}</p>
                            <p><strong>Superviseur:</strong> ${agent.is_supervisor ? 'Oui' : 'Non'}</p>
                        `;
                    } else if (data.user.role === 'client' && data.user.clients && data.user.clients.length > 0) {
                        const client = data.user.clients[0];
                        userInfo += `
                            <p><strong>Code Client:</strong> ${client.client_code}</p>
                        `;
                    } else if (data.user.role === 'admin') {
                        userInfo += `
                            <p><strong>Type:</strong> Administrateur</p>
                        `;
                    } else {
                        userInfo += `
                            <p><strong>Note:</strong> Utilisateur ${data.user.role} sans donn√©es sp√©cifiques</p>
                        `;
                    }

                    userInfo += `
                            <p>üéâ Le nouveau mot de passe fonctionne parfaitement!</p>
                        </div>
                    `;

                    resultDiv.innerHTML = userInfo;
                } else {
                    resultDiv.innerHTML = `<div class="error"><h3>‚ùå √âchec de connexion:</h3><p>${data.error}</p></div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h3>‚ùå Erreur r√©seau:</h3><p>${error.message}</p></div>`;
            }
        }

        async function generateTempPassword() {
            const length = document.getElementById('passwordLength').value;
            const resultDiv = document.getElementById('temp-password-result');
            
            try {
                const response = await fetch(`/api/admin/change-password?length=${length}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>üé≤ Mot de passe g√©n√©r√© :</h3>
                            <p style="font-size: 18px; font-family: monospace; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                                <strong>${data.temporary_password}</strong>
                            </p>
                            <p>üí° Vous pouvez copier ce mot de passe pour l'utiliser</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur r√©seau : ${error.message}</div>`;
            }
        }

        // Charger automatiquement les utilisateurs au d√©marrage
        window.onload = function() {
            loadUsers();
        };
    </script>
</body>
</html>
