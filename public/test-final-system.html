<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final du Syst√®me</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            cursor: pointer; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto;
            border-left: 4px solid #007bff;
            font-size: 12px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Final du Syst√®me Admin</h1>
        <p>Test complet de toutes les fonctionnalit√©s impl√©ment√©es</p>
        
        <div class="test-section">
            <h2>üìä R√©sum√© des Tests</h2>
            <div id="test-summary">
                <div class="grid">
                    <div>
                        <h4>‚úÖ Tests R√©ussis</h4>
                        <div id="success-count">0</div>
                    </div>
                    <div>
                        <h4>‚ùå Tests √âchou√©s</h4>
                        <div id="error-count">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>1. Test des APIs de Base</h2>
            <button class="btn-primary" onclick="testBasicAPIs()">üîç Tester les APIs</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <h2>2. Test de Cr√©ation d'Agent</h2>
            <button class="btn-success" onclick="testCreateAgent()">‚ûï Cr√©er Agent Test</button>
            <div id="create-agent-results"></div>
        </div>

        <div class="test-section">
            <h2>3. Test de Changement de Mot de Passe</h2>
            <button class="btn-warning" onclick="testPasswordChange()">üîë Tester Changement MDP</button>
            <div id="password-results"></div>
        </div>

        <div class="test-section">
            <h2>4. Test de Connexion</h2>
            <button class="btn-info" onclick="testLogin()">üö™ Tester Connexions</button>
            <div id="login-results"></div>
        </div>

        <div class="test-section">
            <h2>5. Test de Modification d'Agent</h2>
            <button class="btn-primary" onclick="testUpdateAgent()">‚úèÔ∏è Tester Modification</button>
            <div id="update-results"></div>
        </div>

        <div class="test-section">
            <h2>6. Test de Suppression</h2>
            <button class="btn-danger" onclick="testDeleteAgent()">üóëÔ∏è Tester Suppression</button>
            <div id="delete-results"></div>
        </div>

        <div class="test-section">
            <h2>üìã Log des Tests</h2>
            <div id="test-log" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;"></div>
        </div>
    </div>

    <script>
        let testResults = { success: 0, error: 0 };
        let testAgentId = null;
        let testUserId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#6c757d';
            logDiv.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateSummary() {
            document.getElementById('success-count').textContent = testResults.success;
            document.getElementById('error-count').textContent = testResults.error;
        }

        async function testBasicAPIs() {
            const resultDiv = document.getElementById('api-results');
            resultDiv.innerHTML = '<p>‚è≥ Test des APIs de base...</p>';
            log('üîç D√©but test APIs de base');

            const tests = [
                { name: 'API Agents', url: '/api/admin/agents' },
                { name: 'API Utilisateurs', url: '/api/admin/users' },
                { name: 'API G√©n√©ration MDP', url: '/api/admin/change-password?length=8' }
            ];

            let results = '<div class="info"><h3>üì° R√©sultats des APIs :</h3>';
            let allSuccess = true;

            for (const test of tests) {
                try {
                    const response = await fetch(test.url);
                    const data = await response.json();
                    
                    if (data.success || response.ok) {
                        results += `<div class="status-badge status-success">‚úÖ ${test.name}</div>`;
                        log(`‚úÖ ${test.name} : OK`, 'success');
                    } else {
                        results += `<div class="status-badge status-error">‚ùå ${test.name}</div>`;
                        log(`‚ùå ${test.name} : ${data.error || 'Erreur'}`, 'error');
                        allSuccess = false;
                    }
                } catch (error) {
                    results += `<div class="status-badge status-error">‚ùå ${test.name}</div>`;
                    log(`‚ùå ${test.name} : ${error.message}`, 'error');
                    allSuccess = false;
                }
            }

            results += '</div>';
            resultDiv.innerHTML = results;
            
            if (allSuccess) {
                testResults.success++;
                log('‚úÖ Test APIs de base : R√âUSSI', 'success');
            } else {
                testResults.error++;
                log('‚ùå Test APIs de base : √âCHOU√â', 'error');
            }
            updateSummary();
        }

        async function testCreateAgent() {
            const resultDiv = document.getElementById('create-agent-results');
            resultDiv.innerHTML = '<p>‚è≥ Cr√©ation d\'un agent test...</p>';
            log('‚ûï D√©but cr√©ation agent test');

            try {
                const response = await fetch('/api/admin/agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: 'Test',
                        last_name: 'Final',
                        email: `test.final.${Date.now()}@esignpro.ch`,
                        phone: '+41 79 999 99 99',
                        department: 'Test',
                        role: 'agent',
                        is_supervisor: false,
                        password: 'testfinal123'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    testAgentId = data.agent.id;
                    testUserId = data.agent.user_id;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Agent cr√©√© avec succ√®s!</h3>
                            <p><strong>ID:</strong> ${data.agent.id}</p>
                            <p><strong>Code:</strong> ${data.agent.agent_code}</p>
                            <p><strong>Email:</strong> ${data.agent.email}</p>
                        </div>
                    `;
                    testResults.success++;
                    log(`‚úÖ Agent cr√©√© : ${data.agent.agent_code}`, 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${data.error}</div>`;
                    testResults.error++;
                    log(`‚ùå Cr√©ation agent √©chou√©e : ${data.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur r√©seau : ${error.message}</div>`;
                testResults.error++;
                log(`‚ùå Erreur r√©seau cr√©ation agent : ${error.message}`, 'error');
            }
            updateSummary();
        }

        async function testPasswordChange() {
            if (!testUserId) {
                document.getElementById('password-results').innerHTML = '<div class="warning">‚ö†Ô∏è Cr√©ez d\'abord un agent</div>';
                return;
            }

            const resultDiv = document.getElementById('password-results');
            resultDiv.innerHTML = '<p>‚è≥ Test changement de mot de passe...</p>';
            log('üîë D√©but test changement mot de passe');

            try {
                const newPassword = 'nouveautest123';
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: testUserId,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Mot de passe chang√©!</h3>
                            <p><strong>Utilisateur:</strong> ${data.user.full_name}</p>
                            <p><strong>Nouveau MDP:</strong> ${newPassword}</p>
                        </div>
                    `;
                    testResults.success++;
                    log(`‚úÖ Mot de passe chang√© pour : ${data.user.email}`, 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${data.error}</div>`;
                    testResults.error++;
                    log(`‚ùå Changement MDP √©chou√© : ${data.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur r√©seau : ${error.message}</div>`;
                testResults.error++;
                log(`‚ùå Erreur r√©seau changement MDP : ${error.message}`, 'error');
            }
            updateSummary();
        }

        async function testLogin() {
            const resultDiv = document.getElementById('login-results');
            resultDiv.innerHTML = '<p>‚è≥ Test des connexions...</p>';
            log('üö™ D√©but test connexions');

            // Test avec un agent connu
            const testCases = [
                { email: 'agent.test@esignpro.ch', password: 'test123', name: 'Agent Test' }
            ];

            let results = '<div class="info"><h3>üîê R√©sultats des connexions :</h3>';
            let allSuccess = true;

            for (const testCase of testCases) {
                try {
                    // Essayer agent-login d'abord
                    let response = await fetch('/api/auth/agent-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: testCase.email,
                            password: testCase.password
                        })
                    });

                    let data = await response.json();

                    // Si √©chec, essayer user-login
                    if (!data.success) {
                        response = await fetch('/api/auth/user-login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: testCase.email,
                                password: testCase.password
                            })
                        });
                        data = await response.json();
                    }
                    
                    if (data.success) {
                        results += `<div class="status-badge status-success">‚úÖ ${testCase.name}</div>`;
                        log(`‚úÖ Connexion r√©ussie : ${testCase.email}`, 'success');
                    } else {
                        results += `<div class="status-badge status-error">‚ùå ${testCase.name}</div>`;
                        log(`‚ùå Connexion √©chou√©e : ${testCase.email} - ${data.error}`, 'error');
                        allSuccess = false;
                    }
                } catch (error) {
                    results += `<div class="status-badge status-error">‚ùå ${testCase.name}</div>`;
                    log(`‚ùå Erreur connexion : ${testCase.email} - ${error.message}`, 'error');
                    allSuccess = false;
                }
            }

            results += '</div>';
            resultDiv.innerHTML = results;
            
            if (allSuccess) {
                testResults.success++;
                log('‚úÖ Test connexions : R√âUSSI', 'success');
            } else {
                testResults.error++;
                log('‚ùå Test connexions : √âCHOU√â', 'error');
            }
            updateSummary();
        }

        async function testUpdateAgent() {
            if (!testAgentId) {
                document.getElementById('update-results').innerHTML = '<div class="warning">‚ö†Ô∏è Cr√©ez d\'abord un agent</div>';
                return;
            }

            const resultDiv = document.getElementById('update-results');
            resultDiv.innerHTML = '<p>‚è≥ Test modification agent...</p>';
            log('‚úèÔ∏è D√©but test modification agent');

            try {
                const response = await fetch(`/api/admin/agents/${testAgentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: 'Test',
                        last_name: 'Final Modifi√©',
                        department: 'Test Modifi√©',
                        is_supervisor: true
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Agent modifi√©!</h3>
                            <p><strong>Nouveau nom:</strong> ${data.agent.first_name} ${data.agent.last_name}</p>
                            <p><strong>Nouveau d√©partement:</strong> ${data.agent.department}</p>
                        </div>
                    `;
                    testResults.success++;
                    log(`‚úÖ Agent modifi√© : ${testAgentId}`, 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${data.error}</div>`;
                    testResults.error++;
                    log(`‚ùå Modification agent √©chou√©e : ${data.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur r√©seau : ${error.message}</div>`;
                testResults.error++;
                log(`‚ùå Erreur r√©seau modification agent : ${error.message}`, 'error');
            }
            updateSummary();
        }

        async function testDeleteAgent() {
            if (!testAgentId) {
                document.getElementById('delete-results').innerHTML = '<div class="warning">‚ö†Ô∏è Cr√©ez d\'abord un agent</div>';
                return;
            }

            if (!confirm('Confirmer la suppression de l\'agent de test ?')) {
                return;
            }

            const resultDiv = document.getElementById('delete-results');
            resultDiv.innerHTML = '<p>‚è≥ Test suppression agent...</p>';
            log('üóëÔ∏è D√©but test suppression agent');

            try {
                const response = await fetch(`/api/admin/agents/${testAgentId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Agent supprim√©!</h3>
                            <p>L'agent de test a √©t√© supprim√© avec succ√®s</p>
                        </div>
                    `;
                    testResults.success++;
                    log(`‚úÖ Agent supprim√© : ${testAgentId}`, 'success');
                    testAgentId = null;
                    testUserId = null;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${data.error}</div>`;
                    testResults.error++;
                    log(`‚ùå Suppression agent √©chou√©e : ${data.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur r√©seau : ${error.message}</div>`;
                testResults.error++;
                log(`‚ùå Erreur r√©seau suppression agent : ${error.message}`, 'error');
            }
            updateSummary();
        }

        // Initialisation
        window.onload = function() {
            log('üöÄ Syst√®me de test initialis√©');
            updateSummary();
        };
    </script>
</body>
</html>
