<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction Automatique Connexion</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            cursor: pointer; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
            background: #007bff;
            color: white;
        }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; }
        .log { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .step.success { border-left-color: #28a745; }
        .step.error { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction Automatique du Probl√®me de Connexion</h1>
        
        <div class="section info">
            <h2>üéØ Probl√®me D√©tect√©</h2>
            <p>L'utilisateur <strong>agent.test@esignpro.ch</strong> existe mais le mot de passe ne correspond pas √† "test123".</p>
            <p>Cette page va automatiquement :</p>
            <ul>
                <li>‚úÖ V√©rifier l'utilisateur dans la base</li>
                <li>üîë R√©initialiser le mot de passe √† "test123"</li>
                <li>üö™ Tester la connexion</li>
                <li>üéâ Confirmer que tout fonctionne</li>
            </ul>
        </div>

        <div class="section">
            <h2>üöÄ Correction Automatique</h2>
            <button class="btn-success" onclick="autoFix()" id="fixBtn">üîß CORRIGER AUTOMATIQUEMENT</button>
            <div id="progress"></div>
        </div>

        <div class="section">
            <h2>üìã Journal des Op√©rations</h2>
            <div id="log" class="log"></div>
        </div>

        <div class="section" id="finalResult" style="display: none;">
            <h2>üéâ R√©sultat Final</h2>
            <div id="finalMessage"></div>
            <div style="margin-top: 20px;">
                <a href="/agent-login" target="_blank" style="display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                    üö™ TESTER LA CONNEXION MAINTENANT
                </a>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#6c757d',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107'
            };
            logDiv.innerHTML += `<div style="color: ${colors[type]}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(step, status, message) {
            const progressDiv = document.getElementById('progress');
            const stepId = `step-${step}`;
            
            let stepDiv = document.getElementById(stepId);
            if (!stepDiv) {
                stepDiv = document.createElement('div');
                stepDiv.id = stepId;
                stepDiv.className = 'step';
                progressDiv.appendChild(stepDiv);
            }
            
            stepDiv.className = `step ${status}`;
            stepDiv.innerHTML = `<strong>√âtape ${step}:</strong> ${message}`;
        }

        async function autoFix() {
            const fixBtn = document.getElementById('fixBtn');
            fixBtn.disabled = true;
            fixBtn.textContent = '‚è≥ Correction en cours...';
            
            log('üöÄ D√©but de la correction automatique', 'info');
            
            try {
                // √âtape 1: V√©rifier l'utilisateur
                updateProgress(1, '', 'V√©rification de l\'utilisateur...');
                log('üîç √âtape 1: V√©rification de l\'utilisateur agent.test@esignpro.ch');
                
                const usersResponse = await fetch('/api/admin/users');
                const usersData = await usersResponse.json();
                
                if (!usersData.success) {
                    throw new Error('Impossible de r√©cup√©rer les utilisateurs');
                }
                
                const user = usersData.users.find(u => u.email === 'agent.test@esignpro.ch');
                if (!user) {
                    updateProgress(1, 'error', 'Utilisateur non trouv√©');
                    log('‚ùå Utilisateur agent.test@esignpro.ch non trouv√©', 'error');
                    throw new Error('Utilisateur non trouv√©');
                }
                
                updateProgress(1, 'success', `Utilisateur trouv√©: ${user.first_name} ${user.last_name}`);
                log(`‚úÖ Utilisateur trouv√©: ${user.first_name} ${user.last_name} (ID: ${user.id})`, 'success');
                
                // √âtape 2: R√©initialiser le mot de passe
                updateProgress(2, '', 'R√©initialisation du mot de passe...');
                log('üîë √âtape 2: R√©initialisation du mot de passe √† "test123"');
                
                const passwordResponse = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.id,
                        new_password: 'test123'
                    })
                });
                
                const passwordData = await passwordResponse.json();
                
                if (!passwordData.success) {
                    updateProgress(2, 'error', `Erreur: ${passwordData.error}`);
                    log(`‚ùå Erreur changement mot de passe: ${passwordData.error}`, 'error');
                    throw new Error(passwordData.error);
                }
                
                updateProgress(2, 'success', 'Mot de passe r√©initialis√© √† "test123"');
                log('‚úÖ Mot de passe r√©initialis√© avec succ√®s', 'success');
                
                // √âtape 3: Tester la connexion avec agent-login
                updateProgress(3, '', 'Test connexion agent-login...');
                log('üö™ √âtape 3: Test de connexion avec API agent-login');
                
                const agentLoginResponse = await fetch('/api/auth/agent-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'agent.test@esignpro.ch',
                        password: 'test123'
                    })
                });
                
                const agentLoginData = await agentLoginResponse.json();
                
                if (agentLoginData.success) {
                    updateProgress(3, 'success', 'Connexion agent-login r√©ussie');
                    log('‚úÖ Connexion agent-login r√©ussie', 'success');
                } else {
                    updateProgress(3, 'warning', 'agent-login √©chou√©, test user-login...');
                    log(`‚ö†Ô∏è agent-login √©chou√©: ${agentLoginData.error}`, 'warning');
                    
                    // √âtape 4: Tester avec user-login
                    updateProgress(4, '', 'Test connexion user-login...');
                    log('üö™ √âtape 4: Test de connexion avec API user-login');
                    
                    const userLoginResponse = await fetch('/api/auth/user-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'agent.test@esignpro.ch',
                            password: 'test123'
                        })
                    });
                    
                    const userLoginData = await userLoginResponse.json();
                    
                    if (userLoginData.success) {
                        updateProgress(4, 'success', 'Connexion user-login r√©ussie');
                        log('‚úÖ Connexion user-login r√©ussie', 'success');
                    } else {
                        updateProgress(4, 'error', `Connexion √©chou√©e: ${userLoginData.error}`);
                        log(`‚ùå Connexion user-login √©chou√©e: ${userLoginData.error}`, 'error');
                        throw new Error('Toutes les tentatives de connexion ont √©chou√©');
                    }
                }
                
                // Succ√®s final
                document.getElementById('finalResult').style.display = 'block';
                document.getElementById('finalMessage').innerHTML = `
                    <div class="success">
                        <h3>üéâ CORRECTION R√âUSSIE !</h3>
                        <p><strong>‚úÖ Utilisateur:</strong> agent.test@esignpro.ch</p>
                        <p><strong>‚úÖ Mot de passe:</strong> test123</p>
                        <p><strong>‚úÖ Connexion:</strong> Fonctionnelle</p>
                        <p><strong>üöÄ Statut:</strong> Pr√™t √† utiliser</p>
                    </div>
                `;
                
                log('üéâ CORRECTION TERMIN√âE AVEC SUCC√àS !', 'success');
                fixBtn.textContent = '‚úÖ CORRECTION TERMIN√âE';
                fixBtn.style.background = '#28a745';
                
            } catch (error) {
                updateProgress('X', 'error', `Erreur: ${error.message}`);
                log(`‚ùå ERREUR G√âN√âRALE: ${error.message}`, 'error');
                
                document.getElementById('finalResult').style.display = 'block';
                document.getElementById('finalMessage').innerHTML = `
                    <div class="error">
                        <h3>‚ùå CORRECTION √âCHOU√âE</h3>
                        <p><strong>Erreur:</strong> ${error.message}</p>
                        <p>Veuillez contacter le support technique.</p>
                    </div>
                `;
                
                fixBtn.textContent = '‚ùå CORRECTION √âCHOU√âE';
                fixBtn.style.background = '#dc3545';
                fixBtn.disabled = false;
            }
        }

        // Auto-d√©marrage apr√®s 2 secondes
        window.onload = function() {
            log('üîß Page de correction automatique charg√©e', 'info');
            log('üí° Cliquez sur "CORRIGER AUTOMATIQUEMENT" pour r√©soudre le probl√®me', 'info');
            
            // D√©marrage automatique apr√®s 3 secondes
            setTimeout(() => {
                if (confirm('D√©marrer la correction automatique maintenant ?')) {
                    autoFix();
                }
            }, 3000);
        };
    </script>
</body>
</html>
