/**
 * Script de test complet de toutes les nouvelles fonctionnalit√©s
 * Usage: node scripts/test-all-features.js
 */

const BASE_URL = 'http://localhost:3000';

// Couleurs pour les logs
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

async function testEmailPreview() {
  log('\nüìß TEST 1: Email Preview API', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    const response = await fetch(`${BASE_URL}/api/email-preview?clientName=Yasmine Massaoudi&token=test123`);
    
    if (response.ok) {
      const html = await response.text();
      const hasBonjour = html.includes('Bonjour Yasmine');
      const hasFullName = html.includes('Bonjour Yasmine Massaoudi');
      
      if (hasBonjour && !hasFullName) {
        log('‚úÖ Format du nom correct: "Bonjour Yasmine" (pr√©nom seulement)', 'green');
      } else {
        log('‚ùå Format du nom incorrect', 'red');
      }
      
      log(`‚úÖ Email preview fonctionne (${response.status})`, 'green');
      return true;
    } else {
      log(`‚ùå Email preview erreur: ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testDocumentsHistory() {
  log('\nüìö TEST 2: Historique des Documents', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    const response = await fetch(`${BASE_URL}/api/agent/documents-history?limit=10`);
    const data = await response.json();
    
    if (data.success) {
      log(`‚úÖ Historique r√©cup√©r√©: ${data.documents.length} document(s)`, 'green');
      log(`   Total: ${data.total} document(s) dans la base`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur: ${data.error}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testAutoSignDocuments() {
  log('\n‚úçÔ∏è TEST 3: Signature Automatique', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    // R√©cup√©rer un dossier avec signature
    const casesResponse = await fetch(`${BASE_URL}/api/agent/clients?status=all&limit=1`);
    const casesData = await casesResponse.json();
    
    if (!casesData.success || casesData.clients.length === 0) {
      log('‚ö†Ô∏è  Aucun dossier disponible pour le test', 'yellow');
      return true;
    }

    const caseId = casesData.clients[0].caseId;
    
    // R√©cup√©rer les documents g√©n√©r√©s
    const docsResponse = await fetch(`${BASE_URL}/api/agent/documents-history?caseId=${caseId}&limit=1`);
    const docsData = await docsResponse.json();
    
    if (!docsData.success || docsData.documents.length === 0) {
      log('‚ö†Ô∏è  Aucun document g√©n√©r√© pour le test', 'yellow');
      return true;
    }

    const documentId = docsData.documents[0].id;
    
    // Tester la signature automatique
    const signResponse = await fetch(`${BASE_URL}/api/agent/auto-sign-documents`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        documentIds: [documentId],
        caseId: caseId
      })
    });
    
    const signData = await signResponse.json();
    
    if (signData.success) {
      log(`‚úÖ Signature automatique r√©ussie: ${signData.signedDocuments.length} document(s)`, 'green');
      return true;
    } else {
      log(`‚ùå Erreur: ${signData.error}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testSendDocumentsEmail() {
  log('\nüìß TEST 4: Envoi Documents par Email', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    // R√©cup√©rer un dossier
    const casesResponse = await fetch(`${BASE_URL}/api/agent/clients?status=all&limit=1`);
    const casesData = await casesResponse.json();
    
    if (!casesData.success || casesData.clients.length === 0) {
      log('‚ö†Ô∏è  Aucun dossier disponible pour le test', 'yellow');
      return true;
    }

    const caseId = casesData.clients[0].caseId;
    
    // R√©cup√©rer les documents
    const docsResponse = await fetch(`${BASE_URL}/api/agent/documents-history?caseId=${caseId}&limit=1`);
    const docsData = await docsResponse.json();
    
    if (!docsData.success || docsData.documents.length === 0) {
      log('‚ö†Ô∏è  Aucun document pour le test', 'yellow');
      return true;
    }

    const documentId = docsData.documents[0].id;
    
    // Tester l'envoi par email
    const emailResponse = await fetch(`${BASE_URL}/api/agent/send-documents-email`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        documentIds: [documentId],
        caseId: caseId,
        message: 'Test automatique - Vos documents sont pr√™ts'
      })
    });
    
    const emailData = await emailResponse.json();
    
    if (emailData.success) {
      log(`‚úÖ Email envoy√© √†: ${emailData.clientEmail}`, 'green');
      log(`   Documents: ${emailData.documentsCount}`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur: ${emailData.error}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testExportStats() {
  log('\nüìä TEST 5: Export Statistiques Excel', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    const response = await fetch(`${BASE_URL}/api/agent/export-stats?period=30`);
    
    if (response.ok) {
      const blob = await response.blob();
      log(`‚úÖ Export Excel g√©n√©r√©: ${blob.size} bytes`, 'green');
      log(`   Type: ${blob.type}`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur export: ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testExportClientDocuments() {
  log('\nüì¶ TEST 6: Export Documents Client (ZIP)', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    // R√©cup√©rer un client
    const clientsResponse = await fetch(`${BASE_URL}/api/agent/clients?status=all&limit=1`);
    const clientsData = await clientsResponse.json();
    
    if (!clientsData.success || clientsData.clients.length === 0) {
      log('‚ö†Ô∏è  Aucun client disponible pour le test', 'yellow');
      return true;
    }

    const caseId = clientsData.clients[0].caseId;
    
    // Tester l'export
    const response = await fetch(`${BASE_URL}/api/agent/export-client-documents?caseId=${caseId}`);
    
    if (response.ok) {
      const blob = await response.blob();
      log(`‚úÖ Export ZIP g√©n√©r√©: ${blob.size} bytes`, 'green');
      log(`   Type: ${blob.type}`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur export: ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testPDFGeneration() {
  log('\nüìÑ TEST 7: G√©n√©ration PDF Sign√©s', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    // R√©cup√©rer un document
    const docsResponse = await fetch(`${BASE_URL}/api/agent/documents-history?limit=1`);
    const docsData = await docsResponse.json();
    
    if (!docsData.success || docsData.documents.length === 0) {
      log('‚ö†Ô∏è  Aucun document disponible pour le test', 'yellow');
      return true;
    }

    const doc = docsData.documents[0];
    
    // Tester la g√©n√©ration PDF
    const response = await fetch(`${BASE_URL}/api/agent/generate-signed-pdf`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        documentId: doc.id,
        caseId: doc.caseId,
        applySignature: true
      })
    });
    
    if (response.ok) {
      const blob = await response.blob();
      log(`‚úÖ PDF g√©n√©r√©: ${blob.size} bytes`, 'green');
      log(`   Type: ${blob.type}`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur g√©n√©ration PDF: ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testClientPortalData() {
  log('\nüîç TEST 8: R√©cup√©ration donn√©es client portal', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    const clientsResponse = await fetch(`${BASE_URL}/api/agent/clients?status=all&limit=1`);
    const clientsData = await clientsResponse.json();

    if (!clientsData.success || clientsData.clients.length === 0) {
      log('‚ö†Ô∏è  Aucun client disponible', 'yellow');
      return true;
    }

    const token = clientsData.clients[0].secureToken;
    const response = await fetch(`${BASE_URL}/api/client/get-case-data?token=${token}`);
    const data = await response.json();

    if (data.success) {
      log(`‚úÖ Donn√©es client r√©cup√©r√©es: ${data.client.firstName} ${data.client.lastName}`, 'green');
      return true;
    } else {
      log(`‚ùå Erreur: ${data.error}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function testDownloadDocuments() {
  log('\nüì¶ TEST 9: T√©l√©chargement documents', 'cyan');
  log('=' .repeat(50), 'cyan');

  try {
    const clientsResponse = await fetch(`${BASE_URL}/api/agent/clients?status=all&limit=1`);
    const clientsData = await clientsResponse.json();

    if (!clientsData.success || clientsData.clients.length === 0) {
      log('‚ö†Ô∏è  Aucun client disponible', 'yellow');
      return true;
    }

    const client = clientsData.clients[0];
    const response = await fetch(`${BASE_URL}/api/agent/download-documents`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        caseId: client.caseId,
        clientId: client.id
      })
    });

    if (response.ok) {
      const blob = await response.blob();
      log(`‚úÖ ZIP g√©n√©r√©: ${blob.size} bytes`, 'green');
      return true;
    } else {
      log(`‚ùå Erreur: ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur: ${error.message}`, 'red');
    return false;
  }
}

async function runAllTests() {
  log('\nüöÄ TESTS COMPLETS - NOUVELLES FONCTIONNALIT√âS', 'cyan');
  log('=' .repeat(70), 'cyan');
  log(`URL de base: ${BASE_URL}`, 'blue');
  log('=' .repeat(70), 'cyan');

  const results = {
    emailPreview: await testEmailPreview(),
    documentsHistory: await testDocumentsHistory(),
    autoSign: await testAutoSignDocuments(),
    sendEmail: await testSendDocumentsEmail(),
    exportStats: await testExportStats(),
    exportClient: await testExportClientDocuments(),
    pdfGeneration: await testPDFGeneration(),
    clientPortalData: await testClientPortalData(),
    downloadDocuments: await testDownloadDocuments()
  };

  // R√©sum√©
  log('\n' + '=' .repeat(70), 'cyan');
  log('üìä R√âSUM√â DES TESTS', 'cyan');
  log('=' .repeat(70), 'cyan');

  const passed = Object.values(results).filter(r => r).length;
  const total = Object.keys(results).length;

  Object.entries(results).forEach(([test, result]) => {
    const icon = result ? '‚úÖ' : '‚ùå';
    const color = result ? 'green' : 'red';
    log(`${icon} ${test}: ${result ? 'R√âUSSI' : '√âCHOU√â'}`, color);
  });

  log('\n' + '=' .repeat(70), 'cyan');
  log(`R√©sultat: ${passed}/${total} tests r√©ussis (${Math.round(passed/total*100)}%)`, 
    passed === total ? 'green' : 'yellow');
  log('=' .repeat(70), 'cyan');

  if (passed === total) {
    log('\nüéâ TOUS LES TESTS SONT PASS√âS !', 'green');
  } else {
    log('\n‚ö†Ô∏è  CERTAINS TESTS ONT √âCHOU√â', 'yellow');
  }
}

// Ex√©cuter les tests
runAllTests().catch(error => {
  log(`\n‚ùå Erreur fatale: ${error.message}`, 'red');
  process.exit(1);
});

